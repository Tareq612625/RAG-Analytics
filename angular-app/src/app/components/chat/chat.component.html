<div class="chat-container">
  <!-- Sub Header -->
  <header class="chat-header">
    <div class="header-content">
      <div class="status-badge" [class.connected]="healthStatus?.status === 'healthy'">
        <span class="status-dot"></span>
        <span class="status-text">
          {{ healthStatus ? healthStatus.llm_provider + ' / ' + healthStatus.llm_model : 'Connecting...' }}
        </span>
      </div>
      <button class="clear-btn" (click)="clearChat()" title="Clear chat">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
        </svg>
      </button>
    </div>
  </header>

  <!-- Messages Area -->
  <main class="messages-area" #messagesContainer>
    <div class="messages-wrapper">
      @for (message of messages; track $index) {
        <div class="message" [class.user]="message.role === 'user'" [class.assistant]="message.role === 'assistant'">
          <div class="message-avatar">
            @if (message.role === 'user') {
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 8V4H8"></path>
                <rect width="16" height="12" x="4" y="8" rx="2"></rect>
                <path d="M2 14h2"></path>
                <path d="M20 14h2"></path>
                <path d="M15 13v2"></path>
                <path d="M9 13v2"></path>
              </svg>
            }
          </div>
          <div class="message-content">
            @if (message.isLoading) {
              <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            } @else {
              <div class="message-text">{{ message.content }}</div>

              @if (message.role === 'assistant' && (message.sql || message.table?.length)) {
                <button class="details-toggle" (click)="toggleDetails($index)">
                  {{ selectedMessageIndex === $index ? 'Hide Details' : 'Show Details' }}
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                       [class.rotated]="selectedMessageIndex === $index">
                    <path d="m6 9 6 6 6-6"></path>
                  </svg>
                </button>

                @if (selectedMessageIndex === $index) {
                  <div class="message-details">
                    @if (message.refined_question) {
                      <div class="detail-section">
                        <h4>Refined Question</h4>
                        <p>{{ message.refined_question }}</p>
                      </div>
                    }

                    @if (message.sql) {
                      <div class="detail-section">
                        <h4>SQL Query</h4>
                        <pre class="sql-code">{{ message.sql }}</pre>
                      </div>
                    }

                    @if (message.table && message.table.length > 0) {
                      <div class="detail-section">
                        <h4>Data Table</h4>
                        <div class="table-wrapper">
                          <table>
                            <thead>
                              <tr>
                                @for (header of getTableHeaders(message.table); track header) {
                                  <th>{{ header }}</th>
                                }
                              </tr>
                            </thead>
                            <tbody>
                              @for (row of message.table; track $index) {
                                <tr>
                                  @for (header of getTableHeaders(message.table); track header) {
                                    <td>{{ formatValue(row[header]) }}</td>
                                  }
                                </tr>
                              }
                            </tbody>
                          </table>
                        </div>
                      </div>
                    }
                  </div>
                }
              }
            }
            <span class="message-time">{{ message.timestamp | date:'shortTime' }}</span>
          </div>
        </div>
      }
    </div>

    <!-- Suggested Questions -->
    @if (messages.length <= 1) {
      <div class="suggestions">
        <p>Try asking:</p>
        <div class="suggestion-chips">
          @for (question of suggestedQuestions; track question) {
            <button class="suggestion-chip" (click)="askSuggested(question)">
              {{ question }}
            </button>
          }
        </div>
      </div>
    }
  </main>

  <!-- Input Area -->
  <footer class="input-area">
    <div class="input-wrapper">
      <input
        #inputField
        type="text"
        [(ngModel)]="userInput"
        (keypress)="onKeyPress($event)"
        placeholder="Ask about your data..."
        [disabled]="isLoading"
      />
      <button
        class="send-btn"
        (click)="sendMessage()"
        [disabled]="!userInput.trim() || isLoading"
      >
        @if (isLoading) {
          <svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
          </svg>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m22 2-7 20-4-9-9-4Z"></path>
            <path d="M22 2 11 13"></path>
          </svg>
        }
      </button>
    </div>
    <p class="disclaimer">AI-powered analytics assistant. Results are based on your database queries.</p>
  </footer>
</div>
