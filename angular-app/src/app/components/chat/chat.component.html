<div class="chat-wrapper" [class.sidebar-open]="isSidebarOpen">
  <!-- Sidebar for Chat History -->
  <aside class="chat-sidebar" [class.open]="isSidebarOpen">
    <div class="sidebar-header">
      <h2>Chat History</h2>
      <button class="new-chat-btn" (click)="startNewChat()" title="New Chat">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"></path>
        </svg>
        New Chat
      </button>
    </div>

    <div class="sidebar-content">
      @if (isLoadingHistory) {
        <div class="history-loading">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      } @else if (chatHistory.length === 0) {
        <div class="no-history">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <p>No chat history</p>
          <span>Start a new conversation</span>
        </div>
      } @else {
        <div class="history-label">Last 24 hours</div>
        <div class="history-list">
          @for (session of chatHistory; track session.conversation_id) {
            <div
              class="history-item"
              [class.active]="isActiveSession(session)"
              (click)="loadConversation(session)"
            >
              <div class="history-item-content">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <div class="history-item-text">
                  <span class="history-title">{{ session.title }}</span>
                  <span class="history-meta">{{ formatDate(session.updated_at) }} Â· {{ session.message_count }} messages</span>
                </div>
              </div>
              <button class="delete-btn" (click)="deleteSession(session, $event)" title="Delete chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                </svg>
              </button>
            </div>
          }
        </div>
      }
    </div>
  </aside>

  <!-- Main Chat Container -->
  <div class="chat-container">
    <!-- Quick Ask Suggestions at Top -->
    @if (messages.length <= 1) {
      <div class="suggestions-top">
        <div class="suggestion-chips">
          @for (question of suggestedQuestions; track question) {
            <button class="suggestion-chip" (click)="askSuggested(question)">
              {{ question }}
            </button>
          }
        </div>
      </div>
    }

    <!-- Messages Area -->
    <main class="messages-area" #messagesContainer>
      <div class="messages-wrapper">
        @for (message of messages; track $index) {
          <div class="message" [class.user]="message.role === 'user'" [class.assistant]="message.role === 'assistant'">
            <div class="message-avatar">
              @if (message.role === 'user') {
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 8V4H8"></path>
                  <rect width="16" height="12" x="4" y="8" rx="2"></rect>
                  <path d="M2 14h2"></path>
                  <path d="M20 14h2"></path>
                  <path d="M15 13v2"></path>
                  <path d="M9 13v2"></path>
                </svg>
              }
            </div>
            <div class="message-content">
              @if (message.isLoading) {
                <div class="loading-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              } @else {
                <div class="message-text">{{ message.content }}</div>

                @if (message.role === 'assistant' && (message.sql || message.table?.length)) {
                  <button class="details-toggle" (click)="toggleDetails($index)">
                    {{ selectedMessageIndex === $index ? 'Hide Details' : 'Show Details' }}
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                         [class.rotated]="selectedMessageIndex === $index">
                      <path d="m6 9 6 6 6-6"></path>
                    </svg>
                  </button>

                  @if (selectedMessageIndex === $index) {
                    <div class="message-details">
                      @if (message.refined_question) {
                        <div class="detail-section">
                          <h4>Refined Question</h4>
                          <p>{{ message.refined_question }}</p>
                        </div>
                      }

                      @if (message.sql) {
                        <div class="detail-section">
                          <h4>SQL Query</h4>
                          <pre class="sql-code">{{ message.sql }}</pre>
                        </div>
                      }

                      @if (message.table && message.table.length > 0) {
                        <div class="detail-section">
                          <h4>Data Table</h4>
                          <div class="table-wrapper">
                            <table>
                              <thead>
                                <tr>
                                  @for (header of getTableHeaders(message.table); track header) {
                                    <th>{{ header }}</th>
                                  }
                                </tr>
                              </thead>
                              <tbody>
                                @for (row of message.table; track $index) {
                                  <tr>
                                    @for (header of getTableHeaders(message.table); track header) {
                                      <td>{{ formatValue(row[header]) }}</td>
                                    }
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        </div>
                      }
                    </div>
                  }
                }
              }
              <span class="message-time">{{ message.timestamp | date:'shortTime' }}</span>
            </div>
          </div>
        }
      </div>
    </main>

    <!-- Compact Input Area (ChatGPT style) -->
    <footer class="input-area">
      <div class="input-container">
        <textarea
          #inputField
          rows="1"
          [(ngModel)]="userInput"
          (keydown)="onKeyDown($event)"
          placeholder="Ask anything"
          [disabled]="isLoading"
        ></textarea>
        <button
          class="send-btn"
          (click)="sendMessage()"
          [disabled]="!userInput.trim() || isLoading"
        >
          @if (isLoading) {
            <svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m22 2-7 20-4-9-9-4Z"></path>
              <path d="M22 2 11 13"></path>
            </svg>
          }
        </button>
      </div>
      <p class="disclaimer">AI-powered analytics assistant. Results are based on your database queries.</p>
    </footer>
  </div>

</div>
